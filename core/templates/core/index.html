<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>High Level Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  {% load widget_tweaks %}

  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <header class="mb-6 flex items-center justify-between gap-4">
      <h1 class="text-2xl font-bold tracking-tight">High Level Planner</h1>
    </header>

    <!-- 2-Column Layout -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
      <!-- LEFT: Prompt Panel -->
      <section class="bg-white border border-gray-200 rounded-2xl shadow-sm p-5">
  <form method="post" action="{% url 'index' %}" enctype="multipart/form-data" id="planner-form" class="space-y-4">
          {% csrf_token %}

          <!-- Fixed Object Prompt Display -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="text-sm font-semibold mb-1">Fixed Object Prompt</div>
            <pre class="text-xs text-blue-900 whitespace-pre-wrap">The image you are currently viewing is from the head-mounted camera, and you should provide a description of the objects you are observing.

Describe them in JSON format.</pre>
          </div>

          <!-- Base Prompt for Get Action -->
          <div>
            <label class="block text-sm font-medium mb-1">Prompt for Get Action</label>
            {{ form.base_prompt|add_class:"w-full h-56 text-sm rounded-lg border-gray-300 shadow-sm focus:ring-blue-600 focus:border-blue-600" }}
          </div>

          <!-- Image Upload -->
          <div>
            <label class="block text-sm font-medium mb-1">Image (1 file)</label>
            {{ form.image|add_class:"block w-full text-sm text-gray-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700" }}
          </div>

          <!-- Text Prompt for Get Action -->
          <div>
            <label class="block text-sm font-medium mb-1">Text Prompt for Get Action</label>
            {{ form.query|add_class:"w-full h-24 text-sm rounded-lg border-gray-300 shadow-sm focus:ring-blue-600 focus:border-blue-600" }}
          </div>

          <!-- Hidden field to carry processed boxed image path -->
          {{ form.processed_image_path }}
          {{ form.raw_image_path }}
          {{ form.segmented_image_path }}
          {{ form.objects_json }}

          <!-- Actions: Get Object / Get Box / Get Segmentation / Get Action -->
          <div class="grid grid-cols-4 gap-3">
            <button type="submit" formmethod="post" formaction="{% url 'get_object' %}"
                    class="py-2.5 px-4 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-lg">
              Get Object
            </button>
            <button type="submit" formmethod="post" formaction="{% url 'get_box' %}"
                    class="py-2.5 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg">
              Get Box
            </button>
            <button type="submit" formmethod="post" formaction="{% url 'get_segmentation' %}"
                    class="py-2.5 px-4 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg">
              Get Segmentation
            </button>
            <button type="submit" formmethod="post" formaction="{% url 'index' %}"
                    class="py-2.5 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg">
              Get Action
            </button>
          </div>

          {% if error %}
            <div class="p-3 bg-red-50 border border-red-200 text-red-800 rounded-lg">
              <div class="font-semibold mb-1">Error</div>
              <pre class="whitespace-pre-wrap text-sm">{{ error }}</pre>
            </div>
          {% endif %}
        </form>
      </section>

  <!-- RIGHT: Image Preview + Outputs -->
      <section class="bg-white border border-gray-200 rounded-2xl shadow-sm p-5 flex flex-col space-y-4">
        <!-- Timings -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
          <h3 class="text-sm font-semibold mb-2">‚è±Ô∏è Timings</h3>
          <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
            <div class="text-gray-600">Get Object</div>
            <div class="text-gray-900 text-right">{% if timings.get_object %}{{ timings.get_object|floatformat:2 }} s{% else %}-{% endif %}</div>
            <div class="text-gray-600">Get Box</div>
            <div class="text-gray-900 text-right">{% if timings.get_box %}{{ timings.get_box|floatformat:2 }} s{% else %}-{% endif %}</div>
            <div class="text-gray-600">Get Segmentation</div>
            <div class="text-gray-900 text-right">{% if timings.get_segmentation %}{{ timings.get_segmentation|floatformat:2 }} s{% else %}-{% endif %}</div>
            <div class="text-gray-600">Get Action</div>
            <div class="text-gray-900 text-right">{% if timings.get_action %}{{ timings.get_action|floatformat:2 }} s{% else %}-{% endif %}</div>
          </div>
          <div class="mt-2 border-t pt-2 flex justify-between text-sm">
            <div class="font-semibold">Total</div>
            <div class="font-semibold">{{ total_time|floatformat:2 }} s</div>
          </div>
        </div>
        <!-- Image Preview -->
        <div id="preview-box"
             class="w-full h-80 border-2 border-dashed border-gray-300 rounded-xl
                    flex items-center justify-center text-gray-500 text-sm p-4 overflow-hidden">

          <div id="preview-placeholder" class="text-center {% if preview_src %}hidden{% endif %}">
            <div class="text-lg font-semibold mb-1">Image Preview</div>
            <div class="text-sm text-gray-400">Uploaded image will appear here.</div>
          </div>

    <img id="preview-image"
      src="{% if preview_src %}{{ preview_src }}{% endif %}"
               alt="Preview"
               class="{% if preview_src %}{% else %}hidden {% endif %}max-h-full max-w-full object-contain rounded-lg" />
        </div>

        <!-- Object JSON Output -->
        <div>
          <h2 class="text-lg font-semibold mb-2">üì¶ Objects (JSON)</h2>
          {% if object_answer %}
            <pre class="whitespace-pre text-gray-800 text-sm leading-relaxed">{{ object_answer }}</pre>
          {% else %}
            <div class="text-sm text-gray-500">Run <span class="font-medium">Get Object</span> to see detected objects JSON.</div>
          {% endif %}
        </div>

        <!-- Action Output -->
        <div class="flex-1">
          <h2 class="text-lg font-semibold mb-2">ü§ñ Action</h2>
          {% if action_answer %}
            <pre class="whitespace-pre-wrap text-gray-800 text-sm leading-relaxed">{{ action_answer }}</pre>
          {% else %}
            <div class="text-sm text-gray-500">Run <span class="font-medium">Get Action</span> to see the action response.</div>
          {% endif %}
        </div>
      </section>
    </div>
  </div>

  <!-- JS: disable button briefly & image preview -->
  <script>
    // Î≤ÑÌäº Ïû†Ïãú ÎπÑÌôúÏÑ±Ìôî (Ï§ëÎ≥µ Ï†úÏ∂ú Î∞©ÏßÄ)
    const form = document.getElementById('planner-form');
    if (form) {
      form.addEventListener('submit', (e) => {
        const btn = e.submitter || form.querySelector('button[type="submit"]');
        if (btn) {
          btn.disabled = true;
          const original = btn.textContent;
          btn.textContent = 'Running...';
          setTimeout(() => { btn.disabled = false; btn.textContent = original; }, 10000);
        }
      });
    }

    // Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù Ïãú Ï¶âÏãú ÌîÑÎ¶¨Î∑∞
    document.addEventListener('DOMContentLoaded', function () {
      const imageInput = document.querySelector('input[name="image"]');
      const previewImage = document.getElementById('preview-image');
      const previewPlaceholder = document.getElementById('preview-placeholder');

      if (!imageInput || !previewImage || !previewPlaceholder) return;

      imageInput.addEventListener('change', function (event) {
        const file = event.target.files && event.target.files[0];
        if (file) {
          const url = URL.createObjectURL(file);
          previewImage.src = url;
          previewImage.classList.remove('hidden');
          previewPlaceholder.classList.add('hidden');
        } else {
          previewImage.src = '';
          previewImage.classList.add('hidden');
          previewPlaceholder.classList.remove('hidden');
        }
      });
    });
  </script>
</body>
</html>



